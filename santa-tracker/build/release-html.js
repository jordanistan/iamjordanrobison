/**
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

const fsp = require('./fsp.js');
const {minify} = require('html-minifier');
const terser = require('terser');
const {JSDOM} = require('jsdom');


const emptyFunc = () => {};


function compileHtml(raw) {
  const mo = {
    collapseBooleanAttributes: true,
    collapseWhitespace: true,
    includeAutoGeneratedTags: false,
    keepClosingSlash: true,
    minifyCSS: true,
    minifyJS: (code) => {
      // nb. html-minifier does NOT see scripts of `type="module"`, which is fine for now as they
      // should be compiled away only in production anyway.
      const result = terser.minify(code);
      if (result.error) {
        throw new Error(`terser error: ${result.error}`);
      }
      return result.code;
    },
    removeComments: true,
    removeEmptyAttributes: true,
    removeRedundantAttributes: true,
    sortAttributes: true,
    sortClassName: true,
  };
  return minify(raw, mo);
}


/**
 * Apply the given attribute to the passed Node.
 *
 * @param {!Node} node 
 * @param {string} attrName 
 * @param {(string|number|boolean|null)=} value 
 */
function applyAttribute(node, attrName, value=true) {
  if (value != null || value !== false) {
    node.setAttribute(attrName, value === true ? '' : '' + value);
  } else {
    node.removeAttribute(attrName);
  }
}


/**
 * @param {!Array<string>} qs
 * @param {string} attrName
 * @param {(string|number|boolean|null)=} value
 * @return {!Array<!Element>} matched nodes
 */
function applyAttributeToAll(node, qs, attrName, value=true) {
  const out = [];
  qs.forEach((q) => {
    const nodes = node.querySelectorAll(qs);
    nodes.forEach((node) => applyAttribute(node, attrName, value));
    out.push(...nodes);
  });
  return out;
}


/**
 * Apply the given i18n string to the passed Node.
 *
 * @param {?string} string 
 * @param {!Node} node 
 */
function applyToNode(string, node) {
  if (node.localName === 'meta') {
    if (string === null) {
      node.removeAttribute('content');
    } else {
      node.setAttribute('content', string);
    }
  } else if (node.closest('head') && node.localName !== 'title') {
    throw new Error(`unhandled <head> node: ${node.localName}`);
  } else {
    node.innerHTML = (string !== null ? string : '');
  }
}


/**
 * Builds a helper that applies the specified language to the passed document.
 *
 * @param {!JSDOM} dom 
 * @return {function((function(string): string|null)): string}
 */
function buildApplyLang(dom) {
  const document = dom.window.document;
  const messagesNodeMap = new Map();

  // Find and contain every [msgid] that needs replacing.
  document.querySelectorAll('[msgid]').forEach((node) => {
    messagesNodeMap.set(node, node.getAttribute('msgid'));
    node.removeAttribute('msgid');
  });

  const applyMessages = (messages) => {
    messagesNodeMap.forEach((msgid, node) => {
      const string = (messages ? messages(msgid) : '');
      applyToNode(string, node);
    });
  };

  return (messages) => {
    // set <html lang="...">
    const lang = messages(null);  // null message returns lang
    applyAttribute(document.documentElement, 'lang', lang);
    applyMessages(messages);
    return dom.serialize();
  };
} 


module.exports = {
  applyAttribute,
  applyAttributeToAll,
  buildApplyLang,

  async dom(filename) {
    const raw = await fsp.readFile(filename, 'utf8');
    const source = compileHtml(raw);
    return new JSDOM(source);
  },

  async load(filename, rewriter=emptyFunc) {
    const dom = await this.dom(filename);

    await rewriter(dom.window.document);

    return buildApplyLang(dom);
  },

};
